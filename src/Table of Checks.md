| Check Category | Metric Name                     | Description                                                                 | Core Code (Illustrative)                                                                                                | Explanation of Logic                                                                                                                                                                                             |
|----------------|---------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Completeness** | `[field]_null_percentage`       | Percentage of NULL values in a specific required or optional field.         | `null_count = df.filter(F.col(column).isNull()).count()` <br> `null_percentage = (null_count / total_count) * 100`        | Counts records where the specified column is NULL, then divides by the total record count and multiplies by 100 to get the percentage.                                                                       |
|                | `inconsistent_count`            | Count of records with NULL `procedure_code` but non-NULL `procedure_code_type`. | `df.filter(F.col("procedure_code").isNull() & F.col("procedure_code_type").isNotNull()).count()`                          | Filters records where `procedure_code` is NULL and `procedure_code_type` is not NULL, then counts these records. This applies to MX events.                                                                 |
| **Consistency** | `invalid_date_percent` (RX)     | Percentage of records where `fill_date` is before `date_prescription_written`. | `df.filter(F.col("date_prescription_written").isNotNull() & (F.col("fill_date") < F.col("date_prescription_written"))).count()` | Filters records where `date_prescription_written` is not NULL and `fill_date` is earlier than `date_prescription_written`. The count is then used to calculate a percentage against the total record count.       |
|                | `invalid_date_percent` (MX)     | Percentage of records where `service_date` is after `service_to_date`.        | `df.filter(F.col("service_to_date").isNotNull() & (F.col("service_date") > F.col("service_to_date"))).count()`           | Filters records where `service_to_date` is not NULL and `service_date` is later than `service_to_date`. The count is then used to calculate a percentage against the total record count.                         |
|                | `missing_patient_percent`       | Percentage of patients in events not found in the demographics table.       | `events_df.select("patient_id").distinct().join(demo_df, events_df["patient_id"] == demo_df["patient_id"], "left").filter(F.isnull(demo_df["patient_id"])).count()` | Joins distinct patient IDs from the events table with the demographics table (latest records for the refresh month). Counts patients present in events but not in demographics, then calculates the percentage. |
|                | `outside_enrollment_percent`    | Percentage of events occurring outside patient enrollment periods.            | `events_df.join(enroll_df, (events_df["patient_id"] == enroll_df["patient_id"]) & (events_df[date_col] >= enroll_df["enroll_start"]) & (events_df[date_col] <= enroll_df["enroll_end"]), "left").filter(F.isnull(enroll_df["patient_id"])).count()` | Joins events with enrollment periods based on `patient_id` and event date falling within enrollment start/end dates. Counts events not matching any enrollment period, then calculates the percentage.         |
|                | `after_death_percent`           | Percentage of events occurring after patient death date (plus a threshold). | `events_df.join(mortality_df, events_df["patient_id"] == mortality_df["patient_id"], "inner").filter(events_df[date_col] > mortality_df["patient_death_date"] + MORTALITY_DAYS_THRESHOLD).count()` | Joins events with mortality data. Filters for events where the event date is after the `patient_death_date` plus a predefined threshold (`MORTALITY_DAYS_THRESHOLD`). Calculates the percentage.             |
|                | `missing_npi_percent`           | Percentage of NPIs (e.g., `pharmacy_npi`, `prescriber_npi`) in events not found in the provider table. | `events_df.select(npi_col).distinct().filter(F.col(npi_col).isNotNull()).join(providers_df, events_df[npi_col] == providers_df["npi"], "left").filter(F.isnull(providers_df["npi"])).count()` | For each NPI column, it takes distinct non-null NPIs from events, left joins with the provider table (latest records for the refresh month), and counts NPIs not found in the provider table. Calculates percentage. |
|                | `demographic_stability`         | Status indicating if demographic stability check is implemented.              | `N/A (Placeholder: "NOT IMPLEMENTED")`                                                                                  | This check is noted as not implemented, as it requires comparing the demo table across different refresh periods.                                                                                              |
| **Distribution** | `gender_distribution`           | Distribution of events by patient gender.                                     | `events_with_demo.agg(F.count(F.when(F.upper(F.col("dm.patient_gender")) == 'F', 1)).alias("F_count"), ...)`             | Joins event data with demographic data (latest records for the refresh month). Aggregates counts for 'F', 'M', and 'Other/Unknown' genders. Calculates percentages for each gender group.                       |
|                | `age_distribution`              | Distribution of events by patient age group.                                  | `events_with_demo.agg(F.count(F.when(F.col("dm.age_group") == '0-17', 1)).alias("Age_0_17_count"), ...)`               | Joins event data with demographic data (which includes pre-calculated age groups: 0-17, 18-44, 45-64, 65+, Unknown). Aggregates counts for each age group. Calculates percentages.                          |
|                | `state_distribution`            | Geographic distribution of events by patient state (top 10 states).         | `events_with_geo.groupBy(F.col("geo.patient_state")).agg(F.count("*").alias("event_count")).orderBy(F.desc("event_count")).limit(10)` | Joins events with geographic data (filtered for the current refresh month and valid date ranges). Groups by `patient_state`, counts events, and calculates percentages for the top 10 states.                     |
|                | `[provider_col]_distribution`   | Distribution of events by provider NPI (top 10 providers).                  | `events_df.groupBy(provider_col).agg(F.count("*").alias("event_count")).orderBy(F.desc("event_count")).limit(10)`       | For each relevant provider NPI column (e.g., `pharmacy_npi`, `billing_npi`), groups by the NPI, counts events, and calculates percentages for the top 10 NPIs.                                         |
|                | `cohort_distribution`           | Distribution of events and patients by cohort (top 10 cohorts).             | `events_df.groupBy(cohort_col).agg(F.count("*").alias("event_count"), F.countDistinct("patient_id").alias("patient_count")).orderBy(F.desc("patient_count")).limit(10)` | Groups events by the cohort column (`rx_cohort` or `mx_cohort`). Counts total events and distinct patients per cohort. Reports distribution for the top 10 cohorts by patient count.                       |
| **Temporal** | `overlap_percentage`            | Percentage of patients from the previous month also present in the current month. | `current_patients.join(previous_patients, current_patients["curr_patient_id"] == previous_patients["prev_patient_id"], "full_outer").agg(...F.countDistinct(F.when(F.col("curr_patient_id").isNotNull() & F.col("prev_patient_id").isNotNull(), F.col("curr_patient_id"))).alias("overlapping_patients")...)` | Identifies distinct patients in current and previous refresh months. Calculates the count of patients present in both months and expresses it as a percentage of the previous month's total patients.     |
|                | `new_patients_percentage`       | Percentage of patients in the current month who were not present in the previous month. | `current_patients.join(previous_patients, ..., "full_outer").agg(...F.countDistinct(F.when(F.col("curr_patient_id").isNotNull() & F.col("prev_patient_id").isNull(), F.col("curr_patient_id"))).alias("new_patients")...)` | Identifies distinct patients in current and previous refresh months. Calculates the count of patients present in the current month but not the previous, expressed as a percentage of current month's total patients. |
|                | `retention_rate`                | Percentage of patients from the previous month who are also present in the current month (same as overlap_percentage logic but focused on retention). | `current_events.join(previous_events, F.col("curr.patient_id") == F.col("prev.patient_id"), "inner").select(F.col("curr.patient_id")).distinct().count()` | Counts patients appearing in both the current and previous month's event data. Divides this by the total distinct patients in the previous month to get the retention rate.                               |
|                | `significant_changes_count` (Medication) | Count of NDCs with a significant (>50%) change in patient counts between months (min 10 current patients). | `current_ndc_counts.join(previous_ndc_counts, "ndc11", "full_outer").withColumn("percent_change", ...).filter((F.abs(F.col("percent_change")) > 50) & (F.col("current_patient_count") >= 10)).count()` | Calculates patient counts per NDC for current and previous months. Identifies NDCs where the percentage change in patient count is >50% and the current patient count is at least 10. Skipped if `ndc11` is not present. |
| **Uniqueness** | `[primary_key]_duplicate_percentage` | Percentage of duplicate primary key values (`medical_event_id` or `pharmacy_event_id`). | `duplicate_percentage = ((total_count - distinct_count) / total_count) * 100`                                           | Counts total records and distinct primary key values. The difference (duplicates) is expressed as a percentage of the total count.                                                                       |
|                | `duplicate_record_percentage`   | Percentage of records with duplicate key field combinations (e.g., `patient_id`, `service_date`/`fill_date`, `procedure_code`/`ndc11`). | `events_df.groupBy(key_fields).count().filter(F.col("count") > 1).count()`                                                | Groups records by a combination of key fields. Counts groups that have more than one record (indicating duplicates based on these keys). Expresses this as a percentage of the total record count.             |
| **Validity** | `future_date_percent`           | Percentage of records with `fill_date` or `service_date` in the future.       | `df.filter(F.col(date_column) > F.current_date()).count()`                                                              | Filters records where the main event date (`fill_date` or `service_date`) is after the current date. Calculates the percentage.                                                                        |
|                | `old_date_percent`              | Percentage of records with `fill_date` or `service_date` before 1900.         | `df.filter(F.year(F.col(date_column)) < 1900).count()`                                                                  | Filters records where the year of the main event date is before 1900. Calculates the percentage.                                                                                                      |
|                | `invalid_ndc_percent`           | Percentage of records with invalid NDC format (not 11 digits after removing hyphens). | `df.filter(F.col("ndc11").isNotNull() & (F.length(F.regexp_replace(F.col("ndc11"), "-", "")) != 11)).count()`          | Filters records where `ndc11` is not NULL and its length (after removing hyphens) is not equal to 11. Calculates the percentage. Skipped if `ndc11` column is not present.                               |
|                | `invalid_proc_type_percent` (MX)| Percentage of records with `procedure_code_type` not in the expected list.    | `df.filter(F.col("procedure_code_type").isNotNull() & ~F.upper(F.col("procedure_code_type")).isin(EXPECTED_PROC_CODE_TYPES)).count()` | Filters MX event records where `procedure_code_type` is not NULL and not one of the `EXPECTED_PROC_CODE_TYPES`. Calculates the percentage.                                                               |
|                | `negative_quantity_percent` (RX)| Percentage of RX records with non-positive `quantity`.                        | `df.filter(F.col("quantity").isNotNull() & (F.col("quantity") <= 0)).count()`                                           | Filters RX event records where `quantity` is not NULL and is less than or equal to 0. Calculates the percentage.                                                                                             |
|                | `extreme_quantity_percent` (RX) | Percentage of RX records with `quantity` greater than `EXTREME_UNITS_THRESHOLD`. | `df.filter(F.col("quantity").isNotNull() & (F.col("quantity") > EXTREME_UNITS_THRESHOLD)).count()`                      | Filters RX event records where `quantity` is not NULL and exceeds a predefined `EXTREME_UNITS_THRESHOLD`. Calculates the percentage.                                                                         |
|                | `negative_days_percent` (RX)    | Percentage of RX records with non-positive `days_supply`.                     | `df.filter(F.col("days_supply").isNotNull() & (F.col("days_supply") <= 0)).count()`                                      | Filters RX event records where `days_supply` is not NULL and is less than or equal to 0. Calculates the percentage.                                                                                          |
|                | `negative_units_percent` (MX)   | Percentage of MX records with non-positive `units`.                           | `df.filter(F.col("units").isNotNull() & (F.col("units") <= 0)).count()`                                                 | Filters MX event records where `units` is not NULL and is less than or equal to 0. Calculates the percentage.                                                                                                |
|                | `extreme_units_percent` (MX)    | Percentage of MX records with `units` greater than `EXTREME_UNITS_THRESHOLD`.   | `df.filter(F.col("units").isNotNull() & (F.col("units") > EXTREME_UNITS_THRESHOLD)).count()`                            | Filters MX event records where `units` is not NULL and exceeds a predefined `EXTREME_UNITS_THRESHOLD`. Calculates the percentage.                                                                            |
|                | `invalid_unit_type_percent` (MX)| Percentage of MX records with `unit_type` not in the expected list.           | `df.filter(F.col("unit_type").isNotNull() & ~F.upper(F.col("unit_type")).isin(EXPECTED_UNIT_TYPES)).count()`             | Filters MX event records where `unit_type` is not NULL and not one of the `EXPECTED_UNIT_TYPES`. Calculates the percentage.                                                                                |
|                | `invalid_[npi_col]_percent`     | Percentage of records with invalid NPI format (not 10 digits).                | `df.filter(F.col(npi_col).isNotNull() & ((F.length(F.col(npi_col)) != 10) | (F.col(npi_col).rlike("[^0-9]")))).count()` | For each NPI column, filters records where the NPI is not NULL and either its length is not 10 or it contains non-digit characters. Calculates the percentage.                                      |
|                | `invalid_order_percent` (RX)    | Percentage of RX records with `fill_date` before `date_prescription_written`. | `df.filter(F.col("date_prescription_written").isNotNull() & (F.col("fill_date") < F.col("date_prescription_written"))).count()` | Filters RX records where `date_prescription_written` is not NULL and `fill_date` is earlier than `date_prescription_written`. Calculates the percentage.                                                   |
|                | `future_service_to_date_percent` (MX) | Percentage of MX records with `service_to_date` in the future.            | `df.filter(F.col("service_to_date").isNotNull() & (F.col("service_to_date") > F.current_date())).count()`             | Filters MX records where `service_to_date` is not NULL and is after the current date. Calculates the percentage.                                                                                             |
| **Volume** | `current_count_record` (Record)        | Total record count for the current refresh month.                             | `base_df.filter(F.date_format(F.col("kh_refresh_date"), "yyyy-MM") == self.refresh_month).agg(F.count("*")).first()["record_count"]` | Filters the base dataframe for the current `refresh_month` and counts all records.                                                                                                                             |
|                | `change_percentage` (Record)    | Percentage change in record count compared to the previous refresh month.     | `((current_count - previous_count) / previous_count) * 100`                                                             | Calculates the percentage difference between the current month's record count and the previous month's record count.                                                                                           |
|                | `current_count_patients` (Patient)       | Total distinct patient count for the current refresh month.                   | `base_df.filter(F.date_format(F.col("kh_refresh_date"), "yyyy-MM") == self.refresh_month).agg(F.countDistinct("patient_id")).first()["distinct_patient_count"]` | Filters the base dataframe for the current `refresh_month` and counts distinct `patient_id`s.                                                                                                              |
|                | `change_percentage` (Patient)   | Percentage change in distinct patient count compared to the previous month. | `((current_count - previous_count) / previous_count) * 100`                                                             | Calculates the percentage difference between the current month's distinct patient count and the previous month's count.                                                                                      |
|                | `current_count_codes` (Code)          | Total distinct code count (`ndc11` or `procedure_code`) for the current month.| `base_df.filter(...).agg(F.countDistinct(self.code_col)).first()["distinct_code_count"]`                               | Filters for the current month and counts distinct values in the relevant code column (`ndc11` for RX, `procedure_code` for MX). Skipped if the code column is not found.                                   |
|                | `change_percentage` (Code)      | Percentage change in distinct code count compared to the previous month.    | `((current_count - previous_count) / previous_count) * 100`                                                             | Calculates the percentage difference between the current and previous month's distinct code counts. Skipped if the code column is not found.                                                               |
|                | `current_provider_count`        | Distinct provider NPI count for the current month.                            | `base_df.filter(...).agg(F.countDistinct(self.provider_col)).first()["distinct_provider_count"]`                       | Filters for the current month and counts distinct provider NPIs (`prescriber_npi` for RX, `rendering_npi` for MX). Skipped if the provider column is not found.                                           |
|                | `current_patients_with_provider`| Count of distinct patients associated with a provider in the current month.   | `base_df.filter(...).agg(F.expr(f"count(distinct case when {self.provider_col} is not null then patient_id end)")).first()["patients_with_provider"]` | Filters for the current month and counts distinct patients who have a non-null provider NPI. Skipped if the provider column is not found.                                                                 |
|                | `provider_count_change_percentage`| Percentage change in distinct provider NPI count compared to previous month.  | `((current_provider_count - previous_provider_count) / previous_provider_count) * 100`                                  | Calculates the percentage difference between current and previous month's distinct provider counts. Skipped if the provider column is not found.                                                              |
|                | `current_org_count`             | Distinct organization NPI count for the current month.                        | `base_df.filter(...).agg(F.countDistinct(self.org_col)).first()["distinct_org_count"]`                                 | Filters for the current month and counts distinct organization NPIs (`pharmacy_npi` for RX, `billing_npi` for MX). Skipped if the organization column is not found.                                       |
|                | `current_patients_with_org`     | Count of distinct patients associated with an organization in the current month.| `base_df.filter(...).agg(F.expr(f"count(distinct case when {self.org_col} is not null then patient_id end)")).first()["patients_with_org"]` | Filters for the current month and counts distinct patients who have a non-null organization NPI. Skipped if the organization column is not found.                                                          |
|                | `org_count_change_percentage`   | Percentage change in distinct organization NPI count compared to previous month.| `((current_org_count - previous_org_count) / previous_org_count) * 100`                                               | Calculates the percentage difference between current and previous month's distinct organization counts. Skipped if the organization column is not found.                                                     |
|                | `current_payer_count`           | Distinct payer ID count for the current month (MX only).                      | `base_df.filter(...).agg(F.countDistinct(self.payer_col)).first()["distinct_payer_count"]`                             | Filters for the current month and counts distinct payer IDs (`kh_plan_id` for MX). Skipped if the payer column is not found or for RX events.                                                              |
|                | `current_patients_with_payer`   | Count of distinct patients associated with a payer in the current month (MX only).| `base_df.filter(...).agg(F.expr(f"count(distinct case when {self.payer_col} is not null then patient_id end)")).first()["patients_with_payer"]` | Filters for the current month and counts distinct patients who have a non-null payer ID. Skipped if the payer column is not found or for RX events.                                                          |
|                | `payer_count_change_percentage` | Percentage change in distinct payer ID count compared to previous month (MX only).| `((current_payer_count - previous_payer_count) / previous_payer_count) * 100`                                         | Calculates the percentage difference between current and previous month's distinct payer counts. Skipped if the payer column is not found or for RX events.                                                  |
|                | `current_cohort_count`          | Distinct cohort ID count for the current month.                               | `base_df.filter(...).agg(F.countDistinct(self.cohort_col)).first()["distinct_cohort_count"]`                           | Filters for the current month and counts distinct cohort IDs. Skipped if the cohort column is not found.                                                                                                     |
|                | `current_patients_with_cohort`  | Count of distinct patients associated with a cohort in the current month.     | `base_df.filter(...).agg(F.expr(f"count(distinct case when {self.cohort_col} is not null then patient_id end)")).first()["patients_with_cohort"]` | Filters for the current month and counts distinct patients who have a non-null cohort ID. Skipped if the cohort column is not found.                                                                    |
|                | `cohort_count_change_percentage`| Percentage change in distinct cohort ID count compared to previous month.     | `((current_cohort_count - previous_cohort_count) / previous_cohort_count) * 100`                                      | Calculates the percentage difference between current and previous month's distinct cohort counts. Skipped if the cohort column is not found.                                                                 |
|                | `cohort_distribution_changes`   | Count of cohorts with significant patient count changes, new cohorts, or missing cohorts compared to the previous month. | Compares `patient_count` per `cohort_id` between current and previous month's distributions.                               | Identifies cohorts where patient count changed by >=20%, cohorts new to the current month, or cohorts missing from the current month (present in previous). Counts these instances. Skipped if cohort column not found. |

**Note:**
* `(RX)` denotes a check or field primarily relevant to `Stg_rx_events`.
* `(MX)` denotes a check or field primarily relevant to `Stg_mx_events`.
* `[field]` or `[primary_key]` or `[provider_col]` are placeholders for specific column names determined dynamically in the code (e.g., `pharmacy_event_id`, `medical_event_id`, `billing_npi`).
* The "Core Code" provided is illustrative and may be part of a larger chain of operations or helper functions within the actual scripts.
* `df` in the core code snippets typically refers to `self.events_df` or a derivative DataFrame within the check method.
* `F` refers to `pyspark.sql.functions`.
* Thresholds like `NULL_PERCENT_THRESHOLD`, `MORTALITY_DAYS_THRESHOLD`, `EXTREME_UNITS_THRESHOLD`, `RECORD_COUNT_DEV_THRESHOLD`, `PATIENT_COUNT_DEV_THRESHOLD` are defined in `src/config/settings.py`.
* Supporting data (like `demo_df`, `providers_df`, `enroll_df`, `mortality_df`, `geo_df`) are loaded and pre-processed (e.g., filtered for the relevant `refresh_month`, duplicates removed) before being used in joins.
* For Volume checks, `base_df` refers to the full table loaded internally by the `VolumeCheck` class, which is then filtered for current and previous refresh months to get `self.current_counts` and `self.previous_counts`.
